# Parent CI/CD Configuration - defines common stages and includes child pipelines
image: maven:3.8-openjdk-17

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DOCKER_DRIVER: overlay2
  SPRING_PROFILES_ACTIVE: "local"
  # Add common defaults that children can override
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  # Branch configuration
  TARGET_BRANCH_1: "TFMS_dev_v1.0.0"
  TARGET_BRANCH_2: "TFMS_v1.0.0_dev"

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .m2/repository/

# Include child CI configurations
include:
  - local: 'analytics-service/.analytics-service-gitlab-ci.yml'

stages:
  - validate
  - build
  - package
  - test
  - deploy

# Validate project structure only
validate_project:
  stage: validate
  script:
    - echo "Validating Maven project structure..."
    - mvn validate $MAVEN_CLI_OPTS
    - echo "✅ Project validation completed"
  rules:
    - if: '$CI_COMMIT_BRANCH == $TARGET_BRANCH_1'
    - if: '$CI_COMMIT_BRANCH == $TARGET_BRANCH_2'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

check_dependencies:
  stage: validate
  script:
    - echo "Checking for shared dependency changes..."
    - mvn dependency:tree -q $MAVEN_CLI_OPTS
    - echo "✅ Dependency check completed"
  rules:
    - if: '$CI_COMMIT_BRANCH == $TARGET_BRANCH_1'
    - if: '$CI_COMMIT_BRANCH == $TARGET_BRANCH_2'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - changes:
        - "pom.xml"
        - "**/pom.xml"

