image: maven:3.8-openjdk-17

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DOCKER_DRIVER: overlay2
  SPRING_PROFILES_ACTIVE: "local"
cache:
  paths:
    - .m2/repository/
    # Remove target/ from cache as it's ignored

stages:
  - validate
  - build
  # - test
  - package
  - deploy

# Validate project structure and dependencies
validate:
  stage: validate
  script:
    - mvn validate
  only:
    # - main
    - TFMS_v1.0.0_dev
    - merge_requests

# Build all modules
build:
  stage: build
  script:
    - mvn clean compile
  only:
    # - main
    - TFMS_v1.0.0_dev
    - merge_requests

# Package application and create Docker image
package:
  stage: package
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache maven openjdk17
  script:
    - mvn package -DskipTests
    - docker build -t analytics-service:$CI_COMMIT_SHA ./analytics-service
    - docker tag analytics-service:$CI_COMMIT_SHA analytics-service:latest
  only:
    - TFMS_v1.0.0_dev
  artifacts:
    expire_in: 1 week
    paths:
      - analytics-service/target/*.jar

# Deploy to development environment
deploy:
  stage: deploy
  tags:
    - shell
  script:
    - docker compose down || true
    - docker compose up -d
    - echo "Application deployment initiated. Check http://localhost:8090"
    - docker compose logs analytics-service
    - sleep 10
    - docker compose ps
    - docker update --restart=unless-stopped analytics-service
  environment:
    name: development
    url: http://localhost:8090
  only:
    - TFMS_v1.0.0_dev 